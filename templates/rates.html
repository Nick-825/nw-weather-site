{% extends "base.html" %}
{% block content %}
<h2 class="text-2xl font-bold mb-4">–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>

<div class="max-w-3xl">
  <div class="relative">
    <input id="q" type="text" placeholder="USD, EUR, —Ñ—É–Ω—Ç, BTC, TON‚Ä¶"
           class="w-full rounded-2xl bg-slate-900/70 ring-1 ring-white/10 px-4 py-3 outline-none focus:ring-cyan-500" autocomplete="off">
    <div id="suggest" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
  </div>

  <div id="meta" class="mt-3 text-xs text-slate-400"></div>
  <div id="list" class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const q = $('#q');
  const box = $('#suggest');
  const list = $('#list');
  const meta = $('#meta');
  let debounce;

  // –§–æ–ª–±—ç–∫-—Ç–∞–±–ª–∏—Ü–∞ –∑–Ω–∞–∫–æ–≤ –∏ —Ñ–ª–∞–≥–æ–≤ (–µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –Ω–µ –≤–µ—Ä–Ω—É–ª)
  const FALLBACK = {
    USD: {emoji:'üá∫üá∏', symbol:'$'},
    EUR: {emoji:'üá™üá∫', symbol:'‚Ç¨'},
    GBP: {emoji:'üá¨üáß', symbol:'¬£'},
    CNY: {emoji:'üá®üá≥', symbol:'¬•'},
    JPY: {emoji:'üáØüáµ', symbol:'¬•'},
    TRY: {emoji:'üáπüá∑', symbol:'‚Ç∫'},
    KZT: {emoji:'üá∞üáø', symbol:'‚Ç∏'},
    UAH: {emoji:'üá∫üá¶', symbol:'‚Ç¥'},
    AED: {emoji:'üá¶üá™', symbol:'ÿØ.ÿ•'},
    BYN: {emoji:'üáßüáæ', symbol:'Br'},
    AMD: {emoji:'üá¶üá≤', symbol:'÷è'},
    AZN: {emoji:'üá¶üáø', symbol:'‚Çº'},
    EGP: {emoji:'üá™üá¨', symbol:'E¬£'},
    CDF: {emoji:'üá®üá©', symbol:'FC'},
  };
  const CRYPTO_EMOJI = { BTC:'‚Çø', ETH:'Œû', LTC:'≈Å', XMR:'…±', XRP:'‚úï', TON:'üßø', USDT:'‚ÇÆ', BNB:'‚í∑' };

  const applyFallbackMeta = x => {
    const code = (x.code||'').toUpperCase();
    if (!x.emoji && FALLBACK[code]?.emoji) x.emoji = FALLBACK[code].emoji;
    if (!x.symbol && (FALLBACK[code]?.symbol || CRYPTO_EMOJI[code])) x.symbol = FALLBACK[code]?.symbol || CRYPTO_EMOJI[code];
    return x;
    };

  const render = (payload) => {
    const items = (payload && payload.items || []).map(applyFallbackMeta);
    meta.textContent = payload && payload.updated ? `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${payload.updated}` : '';
    list.innerHTML = items.map(x=>{
      const isPos = typeof x.change_percent === 'number' ? x.change_percent >= 0
                  : (typeof x.change === 'number' ? x.change >= 0 : false);
      const delta = (typeof x.change_percent === 'number')
        ? `${isPos ? '‚ñ≤' : '‚ñº'} ${Math.abs(x.change_percent).toFixed(2)}%`
        : (typeof x.change === 'number')
          ? `${isPos ? '‚ñ≤' : '‚ñº'} ${Math.abs(x.change).toFixed(4)}`
          : '';
      const deltaCls = isPos ? 'text-emerald-200' : 'text-rose-200';
      return `
        <article class="relative overflow-hidden rounded-3xl bg-gradient-to-br ${x.accent || 'from-slate-800/80 to-slate-900/80'} p-4 shadow-lg ring-1 ring-white/10">
          <div class="absolute -right-8 -top-10 h-24 w-24 rounded-full bg-white/10 blur-3xl"></div>
          <div class="relative flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-black/20 text-3xl ring-2 ring-white/20">
                ${x.emoji || x.symbol || '¬§'}
              </div>
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-widest text-white/80">${x.code}</div>
                <div class="text-base font-semibold leading-tight text-white">${x.name || ''}</div>
              </div>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
              <div class="text-2xl font-bold text-white sm:text-3xl">
                <span class="align-middle">${x.symbol || x.code}</span>
                <span class="align-middle">${(typeof x.value === 'number') ? x.value.toFixed(4) : '‚Äî'}</span>
              </div>
              ${delta ? `<div class="flex items-center gap-2 text-sm font-medium ${deltaCls}">${delta}</div>` : ``}
            </div>
          </div>
        </article>
      `;
    }).join('');
  };

  // API
  const searchFiat = async (text) => {
    try{
      const res = await fetch(`/api/rates/search?q=${encodeURIComponent(text)}`);
      if (!res.ok) throw 0; return await res.json();
    }catch{ return {updated:'', items:[]}; }
  };
  const searchCrypto = async (text) => {
    try{
      const res = await fetch(`/api/crypto/search?q=${encodeURIComponent(text)}`);
      if (!res.ok) throw 0; return await res.json();
    }catch{ return {updated:'', items:[]}; }
  };

  const buildSuggestions = (lists) => {
    const items = lists.flat().slice(0,10).map(applyFallbackMeta);
    if (!items.length) { box.classList.add('hidden'); return; }
    box.innerHTML = items.map(x=>`
      <button type="button" data-code="${x.code}" class="flex w-full items-center gap-3 px-4 py-2 text-left hover:bg-slate-800">
        <span class="text-xl">${x.emoji || x.symbol || '¬§'}</span>
        <span class="font-medium">${x.code}</span>
        <span class="text-xs text-slate-400 truncate">${x.name || ''}</span>
      </button>
    `).join('');
    box.classList.remove('hidden');
    box.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        q.value = btn.dataset.code;
        box.classList.add('hidden');
        const [fiat, crypto] = await Promise.all([searchFiat(btn.dataset.code), searchCrypto(btn.dataset.code)]);
        const payload = (fiat.items?.length? fiat : (crypto.items?.length? crypto : {items:[]}));
        render(payload);
        meta.textContent = [fiat.updated, crypto.updated].filter(Boolean).join(' ‚Ä¢ ');
      });
    });
  };

  const doSearch = async (text)=>{
    const [fiat, crypto] = await Promise.all([searchFiat(text), searchCrypto(text)]);
    meta.textContent = [fiat.updated, crypto.updated].filter(Boolean).join(' ‚Ä¢ ');
    if (fiat.items?.length || crypto.items?.length) {
      render(fiat.items?.length ? fiat : crypto);
      buildSuggestions([fiat.items||[], crypto.items||[]]);
    } else {
      list.innerHTML = ""; box.classList.add('hidden');
    }
  };

  q.addEventListener('input', ()=>{
    clearTimeout(debounce);
    const text = q.value.trim();
    if (!text) { box.classList.add('hidden'); list.innerHTML=''; meta.textContent=''; return; }
    debounce = setTimeout(()=>doSearch(text), 250);
  });

  // –ü–æ Enter ‚Äî —Å—Ä–∞–∑—É –∏—Å–∫–∞—Ç—å (–≤–∞–∂–Ω–æ –¥–ª—è –∫–æ–¥–∞ –≤–∏–¥–∞ "USD")
  q.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); const text = q.value.trim(); if(text) doSearch(text); }
  });
})();
</script>
{% endblock %}
