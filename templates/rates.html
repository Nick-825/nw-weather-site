{% extends "base.html" %}
{% block content %}
<h2 class="text-2xl font-bold mb-4">Курсы валют</h2>
<p class="text-sm text-slate-400 mb-6">Введите код (USD, EUR, CNY…) или название валюты (например, фунт, иена), выберите из списка и получите курс ЦБ РФ и динамику.</p>

<div class="max-w-3xl">
  <div class="relative">
    <input id="q" type="text" placeholder="Например: фунт, иена, доллар, евро"
           class="w-full rounded-2xl bg-slate-900/70 ring-1 ring-white/10 px-4 py-3 outline-none focus:ring-cyan-500" autocomplete="off">
    <div id="suggest" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
  </div>

  <div id="meta" class="mt-3 text-xs text-slate-400"></div>

  <div id="list" class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
  <div id="empty" class="mt-6 hidden rounded-2xl bg-slate-900/70 p-5 text-sm text-slate-400">Выберите валюту из подсказок, чтобы увидеть курс.</div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const q = $('#q');
  const box = $('#suggest');
  const list = $('#list');
  const meta = $('#meta');
  const empty = $('#empty');
  let debounce;

  const render = (payload) => {
    const items = (payload && payload.items) || [];
    meta.textContent = payload && payload.updated ? `Данные обновлены: ${payload.updated}` : '';
    if (!items.length) {
      list.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');
    list.innerHTML = items.map(x=>{
      const isPos = typeof x.change === 'number' ? x.change >= 0 : false;
      const delta = (typeof x.change_percent === 'number')
        ? `${isPos ? '▲' : '▼'} ${Math.abs(x.change_percent).toFixed(2)}%`
        : (typeof x.change === 'number')
          ? `${isPos ? '▲' : '▼'} ${Math.abs(x.change).toFixed(4)}`
          : '';
      const deltaCls = isPos ? 'text-emerald-200' : 'text-rose-200';
      return `
        <article class="relative overflow-hidden rounded-3xl bg-gradient-to-br ${x.accent || 'from-slate-800/80 to-slate-900/80'} p-4 shadow-lg ring-1 ring-white/10">
          <div class="absolute -right-8 -top-10 h-24 w-24 rounded-full bg-white/10 blur-3xl"></div>
          <div class="relative flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-black/20 text-3xl ring-2 ring-white/20">
                ${x.emoji || x.symbol || '¤'}
              </div>
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-widest text-white/80">${x.code}</div>
                <div class="text-base font-semibold leading-tight text-white">${x.name || ''}</div>
              </div>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
              <div class="text-2xl font-bold text-white sm:text-3xl">
                <span class="align-middle">${x.symbol || x.code}</span>
                <span class="align-middle">${(typeof x.value === 'number') ? x.value.toFixed(4) : '—'}</span>
              </div>
              ${delta ? `<div class="flex items-center gap-2 text-sm font-medium ${deltaCls}">${delta}</div>` : ``}
            </div>
          </div>
        </article>
      `;
    }).join('');
  };

  const search = async (q) => {
    const res = await fetch(`/api/rates/search?q=${encodeURIComponent(q)}`);
    if (!res.ok) throw new Error('Не удалось получить курсы');
    return res.json();
  };

  const buildSuggestions = (payload) => {
    const items = (payload && payload.items) || [];
    if (!items.length) { box.classList.add('hidden'); return; }
    box.innerHTML = items.map(x=>`
      <button type="button" data-code="${x.code}" class="flex w-full items-center gap-3 px-4 py-2 text-left hover:bg-slate-800">
        <span class="text-xl">${x.emoji || x.symbol || '¤'}</span>
        <span class="font-medium">${x.code}</span>
        <span class="text-xs text-slate-400 truncate">${x.name || ''}</span>
      </button>
    `).join('');
    box.classList.remove('hidden');
    box.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        q.value = btn.dataset.code;
        box.classList.add('hidden');
        try {
          const data = await search(btn.dataset.code);
          render(data);
        } catch(e){ alert(e.message || e); }
      });
    });
  };

  q.addEventListener('input', ()=>{
    clearTimeout(debounce);
    const text = q.value.trim();
    if (!text) { box.classList.add('hidden'); list.innerHTML=''; empty.classList.remove('hidden'); meta.textContent=''; return; }
    debounce = setTimeout(async ()=>{
      try {
        const data = await search(text);
        buildSuggestions(data);
      } catch(e){ console.error(e); }
    }, 250);
  });

  // первичный пустой экран
  empty.classList.remove('hidden');
})();
</script>
{% endblock %}
