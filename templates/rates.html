{% extends "base.html" %}
{% block title %}–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç{% endblock %}
{% block content %}
<h2 class="text-2xl sm:text-3xl font-bold mb-6">–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>

<div class="grid gap-10 max-w-5xl">
  <!-- –§–∏–∞—Ç -->
  <section>
    <h3 class="text-lg font-semibold mb-3">–í–∞–ª—é—Ç—ã –¶–ë –†–§</h3>
    <div class="relative">
      <input id="q-fiat" type="text" placeholder="USD, EUR, —Ñ—É–Ω—Ç, —é–∞–Ω—å‚Ä¶"
             class="w-full rounded-2xl bg-slate-900/70 ring-1 ring-white/10 px-4 py-3 outline-none focus:ring-cyan-500" autocomplete="off">
      <div id="suggest-fiat" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
    </div>
    <div id="meta-fiat" class="mt-3 text-xs text-slate-400"></div>
    <div id="list-fiat" class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
  </section>

  <!-- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã -->
  <section>
    <h3 class="text-lg font-semibold mb-3">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h3>
    <div class="relative">
      <input id="q-crypto" type="text" placeholder="BTC, TON, ETH‚Ä¶"
             class="w-full rounded-2xl bg-slate-900/70 ring-1 ring-white/10 px-4 py-3 outline-none focus:ring-cyan-500" autocomplete="off">
      <div id="suggest-crypto" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
    </div>
    <div id="meta-crypto" class="mt-3 text-xs text-slate-400"></div>
    <div id="list-crypto" class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
  </section>
</div>

<script>
(function(){
  const FALLBACK = {
    "USD":{"emoji":"üá∫üá∏","symbol":"$"}, "EUR":{"emoji":"üá™üá∫","symbol":"‚Ç¨"}, "GBP":{"emoji":"üá¨üáß","symbol":"¬£"},
    "CNY":{"emoji":"üá®üá≥","symbol":"¬•"}, "JPY":{"emoji":"üáØüáµ","symbol":"¬•"}, "TRY":{"emoji":"üáπüá∑","symbol":"‚Ç∫"},
    "KZT":{"emoji":"üá∞üáø","symbol":"‚Ç∏"}, "UAH":{"emoji":"üá∫üá¶","symbol":"‚Ç¥"}, "AED":{"emoji":"üá¶üá™","symbol":"ÿØ.ÿ•"},
    "BYN":{"emoji":"üáßüáæ","symbol":"Br"}, "AMD":{"emoji":"üá¶üá≤","symbol":"÷è"}, "AZN":{"emoji":"üá¶üáø","symbol":"‚Çº"},
    "EGP":{"emoji":"üá™üá¨","symbol":"E¬£"}, "CDF":{"emoji":"üá®üá©","symbol":"FC"}
  };
  const CRYPTO_EMOJI = {"BTC":"‚Çø","ETH":"Œû","LTC":"≈Å","XMR":"…±","XRP":"‚úï","TON":"üßø","USDT":"‚ÇÆ","BNB":"‚í∑"};

  const applyFallback = (x) => {
    const code = (x.code||'').toUpperCase();
    if (!x.emoji && FALLBACK[code]?.emoji) x.emoji = FALLBACK[code].emoji;
    if (!x.symbol && (FALLBACK[code]?.symbol || CRYPTO_EMOJI[code])) x.symbol = FALLBACK[code]?.symbol || CRYPTO_EMOJI[code];
    return x;
  };

  const renderCards = (el, payload) => {
    const items = (payload?.items||[]).map(applyFallback);
    el.innerHTML = items.map(x=>{
      const pos = typeof x.change_percent==='number' ? x.change_percent>=0 : (typeof x.change==='number' ? x.change>=0 : null);
      const delta = (typeof x.change_percent==='number') ? `${pos?'‚ñ≤':'‚ñº'} ${Math.abs(x.change_percent).toFixed(2)}%`
                  : (typeof x.change==='number')        ? `${pos?'‚ñ≤':'‚ñº'} ${Math.abs(x.change).toFixed(4)}` : '';
      const cls = pos==null ? '' : (pos ? 'text-emerald-200' : 'text-rose-200');
      return `
        <article class="relative overflow-hidden rounded-3xl bg-gradient-to-br ${x.accent || 'from-slate-800/80 to-slate-900/80'} p-4 shadow-lg ring-1 ring-white/10">
          <div class="relative flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-black/20 text-3xl ring-2 ring-white/20">${x.emoji || x.symbol || '¬§'}</div>
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-widest text-white/80">${x.code}</div>
                <div class="text-base font-semibold leading-tight text-white">${x.name || ''}</div>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-2xl font-bold text-white sm:text-3xl">
                <span class="align-middle">${x.symbol || x.code}</span>
                <span class="align-middle">${(typeof x.value==='number')? x.value.toFixed(4) : '‚Äî'}</span>
              </div>
              ${delta ? `<div class="text-sm font-medium ${cls}">${delta}</div>` : ``}
            </div>
          </div>
        </article>`;
    }).join('');
  };

  // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±–≤—è–∑–∫–∞ –ø–æ–∏—Å–∫–∞ c –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
  function attachSearch({input, box, meta, list, search}) {
    let debounce;
    const hide = ()=> box.classList.add('hidden');
    const show = ()=> box.classList.remove('hidden');

    const buildSuggest = (items)=>{
      if (!items.length) { hide(); return; }
      box.innerHTML = items.slice(0,10).map(x=>`
        <button type="button" data-code="${x.code}" class="flex w-full items-center gap-3 px-4 py-2 text-left hover:bg-slate-800">
          <span class="text-xl">${x.emoji || x.symbol || '¬§'}</span>
          <span class="font-medium">${x.code}</span>
          <span class="text-xs text-slate-400 truncate">${x.name||''}</span>
        </button>`).join('');
      show();
      box.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', async ()=>{
          input.value = b.dataset.code;
          hide();
          const payload = await search(b.dataset.code);
          meta.textContent = payload.updated ? `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${payload.updated}` : '';
          renderCards(list, payload);
        });
      });
    };

    input.addEventListener('input', ()=>{
      clearTimeout(debounce);
      const q = input.value.trim();
      if(!q){ hide(); list.innerHTML=''; meta.textContent=''; return; }
      debounce = setTimeout(async ()=>{
        const payload = await search(q);
        meta.textContent = payload.updated ? `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${payload.updated}` : '';
        renderCards(list, payload);      // —Å—Ä–∞–∑—É –æ—Ç—Ä–∏—Å–æ–≤–∞–ª–∏
        buildSuggest(payload.items||[]); // –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
      }, 250);
    });

    input.addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const q = input.value.trim(); if(!q) return;
        hide();
        const payload = await search(q);
        meta.textContent = payload.updated ? `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${payload.updated}` : '';
        renderCards(list, payload);
      }
    });

    document.addEventListener('click', (ev)=>{ if(!box.contains(ev.target) && ev.target!==input) hide(); });
  }

  // –§–∏–∞—Ç
  attachSearch({
    input:  document.getElementById('q-fiat'),
    box:    document.getElementById('suggest-fiat'),
    meta:   document.getElementById('meta-fiat'),
    list:   document.getElementById('list-fiat'),
    search: (q)=>fetch(`/api/rates/search?q=${encodeURIComponent(q)}`).then(r=>r.ok?r.json():{items:[],updated:''})
  });

  // –ö—Ä–∏–ø—Ç–æ
  attachSearch({
    input:  document.getElementById('q-crypto'),
    box:    document.getElementById('suggest-crypto'),
    meta:   document.getElementById('meta-crypto'),
    list:   document.getElementById('list-crypto'),
    search: (q)=>fetch(`/api/crypto/search?q=${encodeURIComponent(q)}`).then(r=>r.ok?r.json():{items:[],updated:''})
  });
})();
</script>
{% endblock %}
