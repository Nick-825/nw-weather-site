{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è ‚Äî –ü–æ–≥–æ–¥–∞, –ù–æ–≤–æ—Å—Ç–∏, –ö—É—Ä—Å—ã{% endblock %}
{% block content %}

<h1 class="text-2xl sm:text-3xl font-bold mb-4">–ü–æ–∏—Å–∫ –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</h1>

<!-- –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ -->
<div class="rounded-2xl bg-slate-900/60 ring-1 ring-white/10 p-4 sm:p-5 space-y-4">
  <div class="relative">
    <input id="q-city" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥‚Ä¶"
           class="w-full rounded-2xl bg-slate-900/70 ring-1 ring-white/10 px-4 py-3 outline-none focus:ring-cyan-500" autocomplete="off">
    <div id="suggest-city" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
  </div>

  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
  <div class="flex items-center gap-2">
    <button data-tab="current"  class="tab-btn rounded-2xl px-4 py-2 bg-white/10">–¢–µ–∫—É—â–∞—è</button>
    <button data-tab="today"    class="tab-btn rounded-2xl px-4 py-2 bg-white/5">–°–µ–≥–æ–¥–Ω—è</button>
    <button data-tab="weekly"   class="tab-btn rounded-2xl px-4 py-2 bg-white/5">–ù–∞ 7 –¥–Ω–µ–π</button>
  </div>

  <!-- –ü–ê–ù–ï–õ–ò -->
  <!-- –¢–ï–ö–£–©–ê–Ø -->
  <div data-panel="current" class="rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10 space-y-4">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 id="c-name" class="text-base font-semibold">‚Äî</h3>
        <div id="c-time" class="text-xs text-slate-400">‚Äî</div>
      </div>
      <div class="flex items-center gap-3">
        <span id="c-icon" class="text-3xl">‚òÅÔ∏è</span>
        <div class="text-3xl sm:text-4xl font-bold" id="c-temp">‚Äî</div>
      </div>
    </div>
    <div id="c-desc" class="text-sm text-slate-400">‚Äî</div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–û—â—É—â–∞–µ—Ç—Å—è</div><div id="c-feels" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–í–µ—Ç–µ—Ä</div><div id="c-wind" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–î–∞–≤–ª–µ–Ω–∏–µ</div><div id="c-press" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div id="c-hum" class="font-medium">‚Äî</div></div>
    </div>
  </div>

  <!-- –°–ï–ì–û–î–ù–Ø (—Å–≤–æ–¥–∫–∞ –¥–Ω—è) -->
  <div data-panel="today" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10 space-y-4">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 class="text-base font-semibold">–ü–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="t-date" class="text-xs text-slate-400">‚Äî</div>
      </div>
      <div class="flex items-center gap-3">
        <span id="t-icon" class="text-3xl">‚òÅÔ∏è</span>
      </div>
    </div>
    <div id="t-desc" class="text-sm text-slate-400">‚Äî</div>
    <div class="grid grid-cols-3 gap-3 text-sm">
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ú–∞–∫—Å</div><div id="t-max" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ú–∏–Ω</div><div id="t-min" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ü–æ—Ä—ã–≤—ã</div><div id="t-wind" class="font-medium">‚Äî</div></div>
    </div>
    <div class="grid grid-cols-3 gap-3 text-sm">
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–û—Å–∞–¥–∫–∏ –∑–∞ —Å—É—Ç–∫–∏</div><div id="t-precip" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–í–æ—Å—Ö–æ–¥</div><div id="t-sunrise" class="font-medium">‚Äî</div></div>
      <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ó–∞–∫–∞—Ç</div><div id="t-sunset" class="font-medium">‚Äî</div></div>
    </div>
  </div>

  <!-- –ù–ï–î–ï–õ–Ø -->
  <div data-panel="weekly" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10">
    <div id="w-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>

<script>
(function(){
  // helpers
  const $ = s=>document.querySelector(s);
  const fmtNum=(v,d=1)=> (typeof v==="number" && !Number.isNaN(v)) ? v.toFixed(d): "‚Äî";
  const fmtUnit=(v,u="",d=1)=> v==null? "‚Äî" : `${fmtNum(v,d)}${u && !u.startsWith('¬∞')? ' '+u : u}`;
  const fmtTime = iso => { const dt = new Date(iso); return Number.isNaN(dt)? "‚Äî" : dt.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}); };
  const fmtDate = iso => { const dt = new Date(iso); if(Number.isNaN(dt)) return "‚Äî"; const s=dt.toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long"}); return s[0].toUpperCase()+s.slice(1); };
  const setPanel = key => {
    document.querySelectorAll('[data-panel]').forEach(p=> p.classList.toggle('hidden', p.getAttribute('data-panel')!==key));
    document.querySelectorAll('.tab-btn').forEach(b=> b.classList.toggle('bg-white/10', b.getAttribute('data-tab')===key));
    document.querySelectorAll('.tab-btn').forEach(b=> b.classList.toggle('bg-white/5', b.getAttribute('data-tab')!==key));
  };

  // –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
  const iq = $('#q-city'), box = $('#suggest-city');
  let db;
  const hideBox = ()=> box.classList.add('hidden');
  const showBox = ()=> box.classList.remove('hidden');
  iq.addEventListener('input', ()=>{
    clearTimeout(db);
    const q = iq.value.trim();
    if(!q){ hideBox(); return; }
    db = setTimeout(async ()=>{
      const r = await fetch(`/api/geo?q=${encodeURIComponent(q)}`);
      const payload = await r.json();
      const items = payload?.items||[];
      if(!items.length){ hideBox(); return; }
      box.innerHTML = items.slice(0,10).map(x=>`
        <button type="button" data-lat="${x.lat}" data-lon="${x.lon}" data-name="${x.name}"
                class="flex w-full items-center gap-3 px-4 py-2 text-left hover:bg-slate-800">
          <span class="text-xl">${x.emoji||'üìç'}</span>
          <span class="font-medium">${x.name}</span>
          <span class="text-xs text-slate-400 truncate">${x.country||''}</span>
        </button>`).join('');
      showBox();
      box.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=>{
          hideBox();
          pickCity(b.dataset.lat, b.dataset.lon, b.dataset.name);
          iq.value = b.dataset.name;
        });
      });
    }, 250);
  });
  document.addEventListener('click', (ev)=>{ if(!box.contains(ev.target) && ev.target!==iq) hideBox(); });

  // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
  const fillCurrent = (name,w)=>{
    $('#c-name').textContent = name || '‚Äî';
    $('#c-time').textContent = w.current?.time ? fmtDate(w.current.time)+' ¬∑ '+fmtTime(w.current.time) : '‚Äî';
    $('#c-icon').textContent = w.current?.icon || '‚òÅÔ∏è';
    $('#c-temp').textContent = fmtUnit(w.current?.temp, '¬∞C', 1);
    $('#c-desc').textContent = w.current?.desc || '';
    $('#c-feels').textContent = fmtUnit(w.current?.feels_like, '¬∞C', 1);
    $('#c-wind').textContent  = fmtUnit(w.current?.wind, w.current?.wind_unit || '–º/—Å', w.current?.wind_unit==='–º/—Å'?1:0);
    $('#c-press').textContent = fmtUnit(w.current?.pressure, w.current?.pressure_unit || '–º–º —Ä—Ç. —Å—Ç.', 0);
    $('#c-hum').textContent   = fmtUnit(w.current?.humidity, '%', 0);
  };

  const fillToday = (w)=>{
    $('#t-date').textContent   = fmtDate(w.daily?.time);
    $('#t-icon').textContent   = w.current?.icon || '‚òÅÔ∏è';
    $('#t-desc').textContent   = w.current?.desc || '';
    $('#t-max').textContent    = fmtUnit(w.daily?.temp_max, '¬∞C', 1);
    $('#t-min').textContent    = fmtUnit(w.daily?.temp_min, '¬∞C', 1);
    const windU = w.daily_units?.wind_speed_10m_max || w.hourly_units?.wind_speed_10m || '–º/—Å';
    $('#t-wind').textContent   = fmtUnit(w.daily?.wind_max, windU, windU==='–º/—Å'?1:0);
    $('#t-precip').textContent = fmtUnit(w.daily?.precip_sum, w.daily_units?.precipitation_sum || '–º–º', 1);
    $('#t-sunrise').textContent= fmtTime(w.daily?.sunrise);
    $('#t-sunset').textContent = fmtTime(w.daily?.sunset);
  };

  const fillWeekly = (w)=>{
    const list = w.week || [];
    $('#w-list').innerHTML = list.map(d=>`
      <article class="rounded-2xl bg-slate-800/60 p-4 ring-1 ring-white/10">
        <div class="flex items-center justify-between gap-3">
          <div class="font-semibold">${fmtDate(d.date)}</div>
          <div class="text-2xl">${d.icon||'‚õÖÔ∏è'}</div>
        </div>
        <div class="mt-2 text-sm text-slate-300">${d.desc||''}</div>
        <div class="mt-3 flex items-center justify-between text-sm">
          <div>–ú–∞–∫—Å: <span class="font-medium">${fmtUnit(d.tmax,'¬∞C',1)}</span></div>
          <div>–ú–∏–Ω: <span class="font-medium">${fmtUnit(d.tmin,'¬∞C',1)}</span></div>
        </div>
      </article>`).join('');
  };

  const pickCity = async (lat,lon,name)=>{
    const r = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
    const w = await r.json();
    fillCurrent(name, w);      // ¬´–¢–µ–∫—É—â–∞—è¬ª ‚Äî —Å–µ–π—á–∞—Å
    fillToday(w);              // ¬´–°–µ–≥–æ–¥–Ω—è¬ª ‚Äî —Å–≤–æ–¥–∫–∞ –¥–Ω—è
    fillWeekly(w);             // –Ω–µ–¥–µ–ª—è (–µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏—à–ª–∞)
    setPanel('current');
  };

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=> setPanel(b.dataset.tab));
  });
})();
</script>
{% endblock %}
