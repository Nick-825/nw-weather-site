{% extends "base.html" %}
{% block content %}

<section class="space-y-4 md:hidden">
  <div class="rounded-3xl bg-slate-900/80 p-5 ring-1 ring-white/10 shadow-xl">
    <h2 class="text-xl font-semibold">–ü–æ–∏—Å–∫ –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</h2>
    <p class="mt-1 text-sm text-slate-400">–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —É–≤–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π.</p>
    <div class="relative mt-4">
      <input id="mobile-city-input" type="text"
             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú—É—Ä–º–∞–Ω—Å–∫"
             class="w-full rounded-2xl bg-slate-950/70 px-4 py-3 ring-1 ring-white/10 outline-none focus:ring-cyan-500"
             autocomplete="off">
      <div id="mobile-suggestions" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
    </div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button type="button" data-mode="current" class="mobile-mode-btn active rounded-full bg-cyan-500/20 px-4 py-2 text-sm font-semibold text-cyan-200 ring-1 ring-cyan-500/40 transition hover:bg-cyan-500/30">–¢–µ–∫—É—â–∞—è</button>
      <button type="button" data-mode="today" class="mobile-mode-btn rounded-full bg-slate-800/60 px-4 py-2 text-sm font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-slate-700/70">–°–µ–≥–æ–¥–Ω—è</button>
      <button type="button" data-mode="weekly" class="mobile-mode-btn rounded-full bg-slate-800/60 px-4 py-2 text-sm font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-slate-700/70">–ù–∞ 7 –¥–Ω–µ–π</button>
    </div>
    <div id="mobile-output" class="mt-5 space-y-4">
      <div id="mobile-placeholder" class="rounded-2xl border border-dashed border-white/10 p-5 text-sm text-slate-400">
        –ù–∞–π–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
      </div>
      <div data-panel="current" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10 space-y-4">
        <div class="flex flex-col gap-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-base font-semibold" id="mobile-location"></div>
              <div class="text-xs text-slate-400" id="mobile-updated"></div>
            </div>
            <div class="flex items-center gap-2 text-4xl font-bold" id="mobile-temp-wrap">
              <span id="mobile-icon" class="weather-icon calm text-4xl">‚òÅÔ∏è</span>
              <span id="mobile-temp">‚Äî</span>
            </div>
          </div>
          <div class="text-sm text-slate-400" id="mobile-desc"></div>
        </div>
        <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-3">
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–û—â—É—â–∞–µ—Ç—Å—è</div>
            <div class="font-medium" id="mobile-feels">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–û—Å–∞–¥–∫–∏ —Å–µ–π—á–∞—Å</div>
            <div class="font-medium" id="mobile-precip">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–í–µ—Ç–µ—Ä –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="font-medium" id="mobile-wind">‚Äî</div>
          </div>
        </div>
      </div>
      <div data-panel="today" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold">–°—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑</h3>
          <div class="text-xs text-slate-400" id="mobile-daily-date"></div>
        </div>
        <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-2">
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–ú–∞–∫—Å–∏–º—É–º</div>
            <div class="font-medium" id="mobile-daily-max">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–ú–∏–Ω–∏–º—É–º</div>
            <div class="font-medium" id="mobile-daily-min">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–û—Å–∞–¥–∫–∏ –∑–∞ —Å—É—Ç–∫–∏</div>
            <div class="font-medium" id="mobile-daily-precip">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞</div>
            <div class="font-medium" id="mobile-daily-wind">‚Äî</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–í–æ—Å—Ö–æ–¥</div>
            <div class="font-medium" id="mobile-daily-sunrise">‚Äî</div>
          </div>
          <div class="rounded-xl bg-slate-900/80 p-3">
            <div class="mini-badge text-slate-400">–ó–∞–∫–∞—Ç</div>
            <div class="font-medium" id="mobile-daily-sunset">‚Äî</div>
          </div>
        </div>
      </div>
      <div data-panel="weekly" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10">
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-base font-semibold">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</h3>
          <div class="text-xs text-slate-400" id="mobile-weekly-tz"></div>
        </div>
        <div id="mobile-weekly-empty" class="mt-4 text-sm text-slate-400 hidden">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞.</div>
        <div id="mobile-weekly-cards" class="mt-4 flex gap-3 overflow-x-auto pb-2"></div>
      </div>
    </div>
  </div>
</section>

<section class="space-y-4">
  <h2 class="text-2xl font-bold">–ü–æ–≥–æ–¥–∞ (–°–ó–§–û)</h2>
  <p class="text-sm text-slate-400">–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –∫–ª—é—á–µ–≤—ã–º –≥–æ—Ä–æ–¥–∞–º –æ–∫—Ä—É–≥–∞ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ —á–∏—Ç–∞–µ–º—ã –¥–∞–∂–µ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö.</p>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
    {% for row in weather %}
    <article class="flex flex-col gap-4 rounded-2xl bg-slate-900/70 p-5 shadow-lg ring-1 ring-white/10">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-semibold text-lg">{{ row.city }}</div>
          <div class="text-sm text-slate-400">–û—â—É—â–∞–µ—Ç—Å—è: {{ row.feels is not none and '%.1f'|format(row.feels) ~ '¬∞C' or '‚Äî' }}</div>
        </div>
        <div class="text-3xl weather-icon {{ row.anim }}" aria-hidden="true">{{ row.icon or "‚òÅÔ∏è" }}</div>
      </div>
      <div class="text-4xl font-bold tracking-tight">{{ row.temp is not none and '%.1f'|format(row.temp) ~ '¬∞C' or '‚Äî' }}</div>
      <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-3">
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–û—Å–∞–¥–∫–∏ —Å–µ–π—á–∞—Å</div>
          <div class="font-medium">{{ row.precip is not none and '%.1f'|format(row.precip) ~ ' –º–º' or '‚Äî' }}</div>
        </div>
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–í–µ—Ç–µ—Ä —Å–µ–π—á–∞—Å</div>
          <div class="font-medium">{{ row.wind is not none and '%.1f'|format(row.wind) ~ ' –º/—Å' or '‚Äî' }}</div>
        </div>
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          <div class="font-medium">{{ row.wdir is not none and row.wdir|round(0) ~ '¬∞' or '‚Äî' }}</div>
        </div>
      </div>
      <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-4">
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–ú–∞–∫—Å –∑–∞ —Å—É—Ç–∫–∏</div>
          <div class="font-medium">{{ row.temp_max is not none and '%.1f'|format(row.temp_max) ~ '¬∞C' or '‚Äî' }}</div>
        </div>
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–ú–∏–Ω –∑–∞ —Å—É—Ç–∫–∏</div>
          <div class="font-medium">{{ row.temp_min is not none and '%.1f'|format(row.temp_min) ~ '¬∞C' or '‚Äî' }}</div>
        </div>
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–û—Å–∞–¥–∫–∏ –∑–∞ —Å—É—Ç–∫–∏</div>
          <div class="font-medium">{{ row.precip_sum is not none and '%.1f'|format(row.precip_sum) ~ ' –º–º' or '‚Äî' }}</div>
        </div>
        <div class="rounded-xl bg-slate-800/60 p-3">
          <div class="mini-badge text-slate-400">–ü–æ—Ä—ã–≤—ã –¥–æ</div>
          <div class="font-medium">{{ row.wind_max is not none and '%.1f'|format(row.wind_max) ~ ' –º/—Å' or '‚Äî' }}</div>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
</section>

<section class="space-y-3">
  <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
    <h2 class="flex items-center gap-2 text-2xl font-bold">
      <span class="text-3xl">üí±</span>
      –ö—É—Ä—Å—ã –¶–ë –†–§
    </h2>
    {% if rates_updated %}
    <p class="text-xs text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ rates_updated }}</p>
    {% endif %}
  </div>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
    {% for code, r in rates.items() %}
    <article class="relative overflow-hidden rounded-3xl bg-gradient-to-br {{ r.accent }} p-4 shadow-lg ring-1 ring-white/10">
      <div class="absolute -right-8 -top-10 h-24 w-24 rounded-full bg-white/10 blur-3xl"></div>
      <div class="relative flex flex-col gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-black/20 text-3xl ring-2 ring-white/20">
            {{ r.emoji or r.symbol or '¬§' }}
          </div>
          <div class="min-w-0">
            <div class="text-xs uppercase tracking-widest text-white/80">{{ code }}</div>
            <div class="text-base font-semibold leading-tight text-white">{{ r.name }}</div>
          </div>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
          <div class="text-2xl font-bold text-white sm:text-3xl">
            <span class="align-middle">{{ r.symbol or code }}</span>
            <span class="align-middle">{{ '%.4f'|format(r.value) }}</span>
          </div>
          {% if r.change is not none %}
          {% set is_positive = r.change >= 0 %}
          <div class="flex items-center gap-2 text-sm font-medium {% if is_positive %}text-emerald-200{% else %}text-rose-200{% endif %}">
            <span aria-hidden="true">{% if is_positive %}‚ñ≤{% else %}‚ñº{% endif %}</span>
            {% if r.change_percent is not none %}
            <span>{{ '%.2f'|format(r.change_percent|abs) }}%</span>
            {% else %}
            <span>{{ '%.4f'|format(r.change|abs) }}</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
</section>

<section class="space-y-4">
  <h2 class="text-2xl font-bold">–ù–æ–≤–æ—Å—Ç–∏</h2>
  <div class="space-y-3">
    {% for n in headlines %}
    <a href="{{ n.link }}" target="_blank" rel="noopener"
       class="block rounded-2xl bg-slate-900/70 p-4 transition hover:bg-slate-900 ring-1 ring-white/5">
      <div class="text-xs text-slate-400">{{ n.source }} ‚Ä¢ {{ n.published }}</div>
      <div class="font-medium">{{ n.title }}</div>
    </a>
    {% endfor %}
  </div>
</section>

<script>
  (function(){
    const $ = (sel, scope=document) => scope.querySelector(sel);
    const $$ = (sel, scope=document) => Array.from(scope.querySelectorAll(sel));
    const input = $("#mobile-city-input");
    const box = $("#mobile-suggestions");
    const placeholder = $("#mobile-placeholder");
    const panels = $$('[data-panel]');
    const modeButtons = $$(".mobile-mode-btn");
    const setActiveMode = mode => {
      modeButtons.forEach(btn => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('active', isActive);
        btn.classList.toggle('bg-cyan-500/20', isActive);
        btn.classList.toggle('text-cyan-200', isActive);
        btn.classList.toggle('ring-cyan-500/40', isActive);
        btn.classList.toggle('bg-slate-800/60', !isActive);
        btn.classList.toggle('text-slate-200', !isActive);
        btn.classList.toggle('ring-white/10', !isActive);
      });
      panels.forEach(panel => {
        panel.classList.toggle('hidden', panel.dataset.panel !== mode);
      });
    };

    let debounce;
    let weatherPayload = null;
    let weeklyPayload = null;

    const formatNumber = (value, digits = 1) => {
      return typeof value === 'number' && !Number.isNaN(value) ? value.toFixed(digits) : null;
    };

    const formatWithUnit = (value, unit = '', digits = 1) => {
      const num = formatNumber(value, digits);
      if (num === null) return '‚Äî';
      const trimmedUnit = unit ? (unit.startsWith('¬∞') ? unit : ` ${unit}`) : '';
      return `${num}${trimmedUnit}`;
    };

    const formatTime = iso => {
      if (!iso) return '‚Äî';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return iso;
      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    };

    const formatDate = iso => {
      if (!iso) return '';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return iso;
      const raw = date.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    };

    const renderCurrent = () => {
      if (!weatherPayload) { return; }
      const { current, daily, hourly_units } = weatherPayload;
      placeholder.classList.add('hidden');
      const panel = $('[data-panel="current"]');
      panel.classList.remove('hidden');
      $('#mobile-location').textContent = weatherPayload.location || '';
      $('#mobile-updated').textContent = current.time ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(current.time).toLocaleString('ru-RU')}` : '';
      $('#mobile-temp').textContent = formatWithUnit(current.temp, '¬∞C');
      $('#mobile-desc').textContent = current.desc || '';

      const iconEl = $('#mobile-icon');
      iconEl.textContent = current.icon || '‚òÅÔ∏è';
      iconEl.className = `weather-icon ${current.anim || 'calm'} text-4xl`;

      $('#mobile-feels').textContent = formatWithUnit(current.feels, '¬∞C');
      $('#mobile-precip').textContent = formatWithUnit(current.precip, (hourly_units && hourly_units.precipitation) || '–º–º');
      const windUnit = (hourly_units && hourly_units.wind_speed_10m) || '–º/—Å';
      const windDigits = windUnit === '–º/—Å' ? 1 : 0;
      const windSpeed = formatWithUnit(current.wind, windUnit, windDigits);
      const direction = typeof current.wdir === 'number' && !Number.isNaN(current.wdir) ? `${Math.round(current.wdir)}¬∞` : '';
      $('#mobile-wind').textContent = windSpeed === '‚Äî' ? (direction || '‚Äî') : `${windSpeed}${direction ? ` ‚Ä¢ ${direction}` : ''}`;

      if (daily) {
        $('#mobile-daily-date').textContent = formatDate(daily.time);
        $('#mobile-daily-max').textContent = formatWithUnit(daily.temp_max, '¬∞C');
        $('#mobile-daily-min').textContent = formatWithUnit(daily.temp_min, '¬∞C');
        $('#mobile-daily-precip').textContent = formatWithUnit(daily.precip_sum, weatherPayload.daily_units?.precipitation_sum || '–º–º');
        const dailyWindUnit = weatherPayload.daily_units?.wind_speed_10m_max || windUnit;
        const dailyWindDigits = dailyWindUnit === '–º/—Å' ? 1 : 0;
        $('#mobile-daily-wind').textContent = formatWithUnit(daily.wind_max, dailyWindUnit, dailyWindDigits);
        $('#mobile-daily-sunrise').textContent = formatTime(daily.sunrise);
        $('#mobile-daily-sunset').textContent = formatTime(daily.sunset);
      }
    };

    const renderWeekly = () => {
      const panel = $('[data-panel="weekly"]');
      if (!weeklyPayload) {
        $('#mobile-weekly-cards').innerHTML = '';
        $('#mobile-weekly-empty').classList.remove('hidden');
        panel.classList.remove('hidden');
        return;
      }
      $('#mobile-weekly-tz').textContent = weeklyPayload.timezone ? `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${weeklyPayload.timezone}` : '';
      const cards = weeklyPayload.days || [];
      const list = $('#mobile-weekly-cards');
      if (!cards.length) {
        list.innerHTML = '';
        $('#mobile-weekly-empty').classList.remove('hidden');
      } else {
        $('#mobile-weekly-empty').classList.add('hidden');
        list.innerHTML = cards.map(day => {
          const dateLabel = formatDate(day.time);
          const max = formatWithUnit(day.temp_max, weeklyPayload.units?.temperature_2m_max || '¬∞C');
          const min = formatWithUnit(day.temp_min, weeklyPayload.units?.temperature_2m_min || '¬∞C');
          const precip = formatWithUnit(day.precip_sum, weeklyPayload.units?.precipitation_sum || '–º–º');
          const windUnit = weeklyPayload.units?.wind_speed_10m_max || '–º/—Å';
          const windDigits = windUnit === '–º/—Å' ? 1 : 0;
          const wind = formatWithUnit(day.wind_max, windUnit, windDigits);
          const sunrise = formatTime(day.sunrise);
          const sunset = formatTime(day.sunset);
          return `
            <article class="min-w-[180px] shrink-0 rounded-2xl bg-slate-900/80 p-4 text-sm ring-1 ring-white/10">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="text-xs uppercase tracking-wide text-slate-400">${dateLabel}</div>
                  <div class="text-xs text-slate-400">${day.desc || ''}</div>
                </div>
                <span class="weather-icon ${day.anim || 'calm'} text-2xl" aria-hidden="true">${day.icon || '‚òÅÔ∏è'}</span>
              </div>
              <div class="mt-3 font-semibold text-slate-100">${max} / ${min}</div>
              <div class="mt-2 space-y-1 text-xs text-slate-400">
                <div>–û—Å–∞–¥–∫–∏: <span class="text-slate-100">${precip}</span></div>
                <div>–í–µ—Ç–µ—Ä: <span class="text-slate-100">${wind}</span></div>
                <div>–í–æ—Å—Ö–æ–¥: <span class="text-slate-100">${sunrise}</span></div>
                <div>–ó–∞–∫–∞—Ç: <span class="text-slate-100">${sunset}</span></div>
              </div>
            </article>
          `;
        }).join('');
      }
      panel.classList.remove('hidden');
    };

    const fetchWeekly = async (lat, lon) => {
      const res = await fetch(`/api/weather/weekly?lat=${lat}&lon=${lon}`);
      if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑');
      return res.json();
    };

    const fetchDaily = async (lat, lon) => {
      const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑');
      return res.json();
    };

    const handleSelection = async (button) => {
      const lat = button.dataset.lat;
      const lon = button.dataset.lon;
      const name = button.dataset.name;
      input.value = name;
      box.classList.add('hidden');
      try {
        const [weather, weekly] = await Promise.all([
          fetchDaily(lat, lon),
          fetchWeekly(lat, lon)
        ]);
        weather.location = name;
        weatherPayload = weather;
        weeklyPayload = weekly;
        renderCurrent();
        renderWeekly();
        const active = modeButtons.find(btn => btn.classList.contains('active'));
        setActiveMode(active ? active.dataset.mode : 'current');
      } catch (err) {
        alert(err.message || err);
      }
    };

    input?.addEventListener('input', () => {
      clearTimeout(debounce);
      const q = input.value.trim();
      if (!q) {
        box.classList.add('hidden');
        return;
      }
      debounce = setTimeout(async () => {
        const res = await fetch(`/api/cities?q=${encodeURIComponent(q)}`);
        const items = await res.json();
        if (!items.length) {
          box.classList.add('hidden');
          return;
        }
        box.innerHTML = items.map(it => `
          <button type="button" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${it.name}${it.admin1 ? ', '+it.admin1 : ''}${it.country ? ', '+it.country : ''}"
            class="flex w-full flex-col gap-1 px-4 py-2 text-left transition hover:bg-slate-800">
            <span class="font-medium">${it.name}</span>
            <span class="text-xs text-slate-400">${[it.admin1, it.country].filter(Boolean).join(' ‚Ä¢ ')}</span>
          </button>
        `).join('');
        box.classList.remove('hidden');
        box.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => handleSelection(btn));
        });
      }, 250);
    });

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        setActiveMode(mode);
        if (mode === 'weekly') {
          renderWeekly();
        } else if (mode === 'current') {
          renderCurrent();
        }
      });
    });

    setActiveMode('current');
  })();
</script>

{% endblock %}
