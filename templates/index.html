{% extends "base.html" %}
{% block content %}

<!-- –ú–æ–±–∏–ª—å–Ω—ã–π –±–ª–æ–∫: –ø–æ–∏—Å–∫ + –ø–∞–Ω–µ–ª–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ -->
<section class="space-y-4 md:hidden">
  <div class="rounded-3xl bg-slate-900/80 p-5 ring-1 ring-white/10 shadow-xl">
    <h2 class="text-xl font-semibold">–ü–æ–∏—Å–∫ –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</h2>

    <div class="relative mt-4">
      <input id="mobile-city-input" type="text"
             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú—É—Ä–º–∞–Ω—Å–∫"
             class="w-full rounded-2xl bg-slate-950/70 px-4 py-3 ring-1 ring-white/10 outline-none focus:ring-cyan-500"
             autocomplete="off">
      <div id="mobile-suggestions" class="absolute z-20 mt-2 w-full overflow-hidden rounded-2xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button type="button" data-mode="current" class="mobile-mode-btn rounded-full bg-cyan-500/20 px-4 py-2 text-sm font-semibold text-cyan-200 ring-1 ring-cyan-500/40 transition hover:bg-cyan-500/30">–¢–µ–∫—É—â–∞—è</button>
      <button type="button" data-mode="today"   class="mobile-mode-btn rounded-full bg-slate-800/60 px-4 py-2 text-sm font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-slate-700/70">–°–µ–≥–æ–¥–Ω—è</button>
      <button type="button" data-mode="weekly"  class="mobile-mode-btn rounded-full bg-slate-800/60 px-4 py-2 text-sm font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-slate-700/70">–ù–∞ 7 –¥–Ω–µ–π</button>
    </div>

    <div id="mobile-output" class="mt-5 space-y-4">
      <div id="mobile-placeholder" class="rounded-2xl border border-dashed border-white/10 p-5 text-sm text-slate-400">
        –ù–∞–π–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑.
      </div>

      <!-- –¢–ï–ö–£–©–ê–Ø -->
      <div data-panel="current" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="m-cur-title" class="font-semibold"></div>
            <div id="m-cur-time" class="text-xs text-slate-400"></div>
          </div>
          <div class="flex items-center gap-3">
            <span id="m-cur-icon" class="weather-icon calm text-3xl">‚òÅÔ∏è</span>
            <div id="m-cur-temp" class="text-3xl font-bold"></div>
          </div>
        </div>
        <div id="m-cur-desc" class="text-sm text-slate-400"></div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–û—â—É—â–∞–µ—Ç—Å—è</div><div id="m-cur-feels" class="font-medium"></div></div>
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–û—Å–∞–¥–∫–∏</div><div id="m-cur-precip" class="font-medium"></div></div>
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–í–µ—Ç–µ—Ä</div><div id="m-cur-wind" class="font-medium"></div></div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ú–∞–∫—Å</div><div id="m-day-max" class="font-medium"></div></div>
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ú–∏–Ω</div><div id="m-day-min" class="font-medium"></div></div>
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ü–æ—Ä—ã–≤—ã</div><div id="m-day-wind" class="font-medium"></div></div>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–í–æ—Å—Ö–æ–¥</div><div id="m-day-sunrise" class="font-medium"></div></div>
          <div class="rounded-xl bg-slate-800/60 p-3"><div class="text-xs text-slate-400">–ó–∞–∫–∞—Ç</div><div id="m-day-sunset" class="font-medium"></div></div>
        </div>
      </div>

      <!-- –°–ï–ì–û–î–ù–Ø (–ø–æ—á–∞—Å–æ–≤–æ–π) -->
      <div data-panel="today" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10">
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-base font-semibold">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑</h3>
          <div id="m-hourly-date" class="text-xs text-slate-400"></div>
        </div>
        <div id="m-hourly-empty" class="mt-4 text-sm text-slate-400 hidden">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        <div id="m-hourly-cards" class="mt-4 flex gap-3 overflow-x-auto pb-2"></div>
      </div>

      <!-- –ù–ï–î–ï–õ–Ø -->
      <div data-panel="weekly" class="hidden rounded-2xl bg-slate-950/60 p-5 ring-1 ring-white/10">
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-base font-semibold">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</h3>
          <div class="text-xs text-slate-400" id="mobile-weekly-tz"></div>
        </div>
        <div id="mobile-weekly-empty" class="mt-4 text-sm text-slate-400 hidden">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        <div id="mobile-weekly-cards" class="mt-4 flex gap-3 overflow-x-auto pb-2"></div>
      </div>
    </div>
  </div>
</section>

<!-- –ë–ª–æ–∫ –°–ó–§–û —Å–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö -->
<section class="space-y-4 hidden md:block">
  <h2 class="text-2xl font-bold">–ü–æ–≥–æ–¥–∞ (–°–ó–§–û)</h2>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
    {% for row in weather %}
    <!-- –≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    {% endfor %}
  </div>
</section>

<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫—É—Ä—Å—ã (–≤–µ—Ä–Ω—É–ª –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä—ë—Ö –≤–∞–ª—é—Ç) -->
<section class="space-y-3">
  <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
    <h2 class="flex items-center gap-2 text-2xl font-bold"><span class="text-3xl">üí±</span> –ö—É—Ä—Å—ã –¶–ë –†–§</h2>
    {% if rates_updated %}<p class="text-xs text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ rates_updated }}</p>{% endif %}
  </div>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
    {% for code, r in rates.items() %}
    <article class="rounded-3xl bg-gradient-to-br {{ r.accent or 'from-slate-800/80 to-slate-900/80' }} p-4 shadow-lg ring-1 ring-white/10">
      <div class="flex items-center gap-3">
        <div class="grid h-14 w-14 shrink-0 place-items-center rounded-2xl bg-black/20 text-3xl ring-2 ring-white/20">
          {{ r.emoji or r.symbol or '¬§' }}
        </div>
        <div class="min-w-0">
          <div class="text-xs uppercase tracking-widest text-white/80">{{ code }}</div>
          <div class="text-base font-semibold leading-tight text-white">{{ r.name }}</div>
        </div>
      </div>
      <div class="mt-3 text-3xl font-bold text-white">
        <span class="align-middle">{{ r.symbol or code }}</span>
        <span class="align-middle">{{ '%.4f'|format(r.value) }}</span>
      </div>
      {% if r.change_percent is defined %}
        {% set pos = r.change_percent|float >= 0 %}
        <div class="mt-1 text-sm {{ 'text-emerald-200' if pos else 'text-rose-200' }}">
          {{ '‚ñ≤' if pos else '‚ñº' }} {{ r.change_percent|float|abs|round(2) }}%
        </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
</section>

<!-- –ù–æ–≤–æ—Å—Ç–∏ -->
<section class="space-y-4">
  <h2 class="text-2xl font-bold">–ù–æ–≤–æ—Å—Ç–∏</h2>
  <div class="space-y-3">
    {% for n in headlines %}
    <a href="{{ n.link }}" target="_blank" rel="noopener"
       class="block rounded-2xl bg-slate-900/70 p-4 transition hover:bg-slate-900 ring-1 ring-white/5">
      <div class="text-xs text-slate-400">{{ n.source }} ‚Ä¢ {{ n.published }}</div>
      <div class="font-medium">{{ n.title }}</div>
    </a>
    {% endfor %}
  </div>
</section>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const qi = $("#mobile-city-input");
  const box = $("#mobile-suggestions");
  const panels = document.querySelectorAll('[data-panel]');
  const buttons = document.querySelectorAll('.mobile-mode-btn');

  const showPanel = (name) => {
    panels.forEach(p => p.classList.toggle('hidden', p.getAttribute('data-panel') !== name));
    buttons.forEach(b => {
      const active = b.dataset.mode === name;
      b.classList.toggle('bg-cyan-500/20', active);
      b.classList.toggle('text-cyan-200', active);
      b.classList.toggle('ring-cyan-500/40', active);
      b.classList.toggle('bg-slate-800/60', !active);
      b.classList.toggle('text-slate-200', !active);
    });
  };

  buttons.forEach(b => b.addEventListener('click', () => showPanel(b.dataset.mode)));

  let debounce;
  const fmtNum = (v, d=1)=> (typeof v==="number"&&!Number.isNaN(v)? v.toFixed(d): "‚Äî");
  const fmtUnit = (v,u="",d=1)=> v==null? "‚Äî" : `${fmtNum(v,d)}${u && !u.startsWith('¬∞')? ' '+u : u}`;
  const fmtTime = iso => { const dt = new Date(iso); return Number.isNaN(dt)? "‚Äî" : dt.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}); };
  const fmtDate = iso => { const dt = new Date(iso); if(Number.isNaN(dt)) return "‚Äî"; const s=dt.toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long"}); return s[0].toUpperCase()+s.slice(1); };

  const fillCurrent = (name,w) => {
    document.getElementById('mobile-placeholder').classList.add('hidden');
    $('#m-cur-title').textContent = name;
    $('#m-cur-time').textContent = w.current.time ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(w.current.time).toLocaleString('ru-RU')}` : '';
    $('#m-cur-temp').textContent = fmtUnit(w.current.temp,"¬∞C");
    $('#m-cur-desc').textContent = w.current.desc || '';
    const icon = $('#m-cur-icon'); icon.textContent = w.current.icon || "‚òÅÔ∏è"; icon.className = `weather-icon ${w.current.anim||'calm'} text-3xl`;
    const hu = w.hourly_units || {}, du = w.daily_units || {};
    $('#m-cur-feels').textContent = fmtUnit(w.current.feels,"¬∞C");
    $('#m-cur-precip').textContent = fmtUnit(w.current.precip, hu.precipitation || "–º–º");
    const windNow = fmtUnit(w.current.wind, hu.wind_speed_10m || "–º/—Å", (hu.wind_speed_10m||"") === "–º/—Å" ? 1 : 0);
    const wdir = typeof w.current.wdir === "number" ? ` ‚Ä¢ ${Math.round(w.current.wdir)}¬∞` : "";
    $('#m-cur-wind').textContent = (w.current.wind==null? "‚Äî" : windNow + wdir);
    $('#m-day-max').textContent = fmtUnit(w.daily.temp_max, "¬∞C");
    $('#m-day-min').textContent = fmtUnit(w.daily.temp_min, "¬∞C");
    $('#m-day-wind').textContent = fmtUnit(w.daily.wind_max, du.wind_speed_10m_max || hu.wind_speed_10m || "–º/—Å", ((du.wind_speed_10m_max||hu.wind_speed_10m||"") === "–º/—Å")?1:0);
    $('#m-day-sunrise').textContent = fmtTime(w.daily.sunrise);
    $('#m-day-sunset').textContent   = fmtTime(w.daily.sunset);
    showPanel('current');
  };

  const fillHourly = (w) => {
    $('#m-hourly-date').textContent = fmtDate(w.daily.time);
    const c = $('#m-hourly-cards'), empty = $('#m-hourly-empty');
    const hu = w.hourly_units || {};
    if(!Array.isArray(w.hourly) || !w.hourly.length){ c.innerHTML=""; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    const windU = hu.wind_speed_10m || "–º/—Å"; const windD = windU==="–º/—Å"?1:0;
    c.innerHTML = w.hourly.map(p=>`
      <div class="min-w-[140px] shrink-0 rounded-2xl bg-slate-800/60 p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400">${fmtTime(p.time)}</div>
        <div class="mt-2 text-xl font-semibold">${fmtUnit(p.temp,"¬∞C")}</div>
        <div class="text-xs text-slate-400">–û—â—É—â.: ${fmtUnit(p.feels,"¬∞C")}</div>
        <div class="mt-2 grid gap-1 text-xs text-slate-400">
          <div>–û—Å–∞–¥–∫–∏: ${fmtUnit(p.precip, hu.precipitation || "–º–º")}</div>
          <div>–í–µ—Ç–µ—Ä: ${fmtUnit(p.wind, windU, windD)}</div>
        </div>
      </div>
    `).join('');
  };

  const fillWeekly = async (lat,lon,name) => {
    const res = await fetch(`/api/weather/weekly?lat=${lat}&lon=${lon}`); const w = await res.json();
    const units = w.units || {}; const cards = $('#mobile-weekly-cards'); const empty = $('#mobile-weekly-empty');
    $('#mobile-weekly-tz').textContent = w.timezone? `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${w.timezone}` : '';
    if(!Array.isArray(w.days) || !w.days.length){ cards.innerHTML=''; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    const windU = units.wind_speed_10m_max || "–º/—Å"; const windD = windU==="–º/—Å"?1:0;
    cards.innerHTML = w.days.map(d=>`
      <div class="min-w-[160px] shrink-0 rounded-2xl bg-slate-800/60 p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400">${fmtDate(d.time)}</div>
        <div class="mt-1 text-slate-400 text-xs">${d.desc||''}</div>
        <div class="mt-1 text-2xl weather-icon ${d.anim||'calm'}">${d.icon||'‚òÅÔ∏è'}</div>
        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
          <div><span class="text-slate-400 text-xs">–ú–∞–∫—Å</span><div class="font-medium">${fmtUnit(d.temp_max, units.temperature_2m_max || "¬∞C")}</div></div>
          <div><span class="text-slate-400 text-xs">–ú–∏–Ω</span><div class="font-medium">${fmtUnit(d.temp_min, units.temperature_2m_min || "¬∞C")}</div></div>
        </div>
        <div class="mt-1 text-xs text-slate-400">–û—Å–∞–¥–∫–∏: <span class="text-slate-100">${fmtUnit(d.precip_sum, units.precipitation_sum || "–º–º")}</span></div>
        <div class="text-xs text-slate-400">–í–µ—Ç–µ—Ä: <span class="text-slate-100">${fmtUnit(d.wind_max, windU, windD)}</span></div>
      </div>
    `).join('');
  };

  const pickCity = async (lat,lon,name)=>{
    const r = await fetch(`/api/weather?lat=${lat}&lon=${lon}`); const w = await r.json();
    fillCurrent(name, w);
    fillHourly(w);
    await fillWeekly(lat,lon,name);
  };

  qi.addEventListener('input', ()=>{
    clearTimeout(debounce);
    const q = qi.value.trim();
    if(!q){ box.classList.add('hidden'); return; }
    debounce = setTimeout(async ()=>{
      const res = await fetch(`/api/cities?q=${encodeURIComponent(q)}`);
      const items = await res.json();
      if(!items.length){ box.classList.add('hidden'); return; }
      box.innerHTML = items.map(it=>`
        <button class="w-full text-left px-4 py-2 hover:bg-slate-800"
                data-lat="${it.lat}" data-lon="${it.lon}"
                data-name="${it.name}${it.admin1?', '+it.admin1:''}${it.country?', '+it.country:''}">
          ${it.name} <span class="text-slate-400 text-xs">${it.admin1? ' ‚Ä¢ '+it.admin1:''}${it.country? ' ‚Ä¢ '+it.country:''}</span>
        </button>
      `).join('');
      box.classList.remove('hidden');
      box.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', async ()=>{
          qi.value = b.dataset.name;
          box.classList.add('hidden');
          await pickCity(b.dataset.lat, b.dataset.lon, b.dataset.name);
          // –ø–æ UX —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–°–µ–≥–æ–¥–Ω—è¬ª –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞)
          const activeBtn = Array.from(buttons).find(x=>x.classList.contains('text-cyan-200'));
          showPanel(activeBtn ? activeBtn.dataset.mode : 'current');
        });
      });
    }, 250);
  });

  // —Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  showPanel('current');
})();
</script>

{% endblock %}
