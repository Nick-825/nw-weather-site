{% extends "base.html" %}
{% block title %}Главная — Погода{% endblock %}
{% block content %}

<div class="glass" style="padding:18px 18px 8px;margin-bottom:18px">
  <h2 style="margin:0 0 8px 0">Поиск по местоположению</h2>
  <div style="display:grid;gap:12px">
    <input id="city-input" placeholder="Санкт-Петербург" style="border-radius:14px;border:1px solid rgba(255,255,255,.1);background:#0f172a;color:#fff;padding:12px 14px;outline:none" />
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" data-tab="now">Текущая</button>
      <button class="btn" data-tab="today">Сегодня</button>
      <button class="btn" data-tab="week">На 7 дней</button>
    </div>
  </div>
</div>

<!-- Панель: Текущая -->
<section id="panel-now" class="glass" style="padding:16px;display:block">
  <h3 style="margin-top:0">Сейчас</h3>
  <div id="now-wrap">Выберите город…</div>
</section>

<!-- Панель: Сегодня (сводка за день, без почасового списка) -->
<section id="panel-today" class="glass" style="padding:16px;display:none">
  <h3 style="margin-top:0">Погода сегодня</h3>
  <div id="today-date" style="color:#9fb0c3;font-size:13px;margin-bottom:8px"></div>
  <div id="today-desc" style="margin-bottom:8px"></div>
  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Макс</div><div id="today-max" style="font-weight:600"></div></div>
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Мин</div><div id="today-min" style="font-weight:600"></div></div>
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Порывы</div><div id="today-wind" style="font-weight:600"></div></div>
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Осадки за сутки</div><div id="today-prec" style="font-weight:600"></div></div>
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Восход</div><div id="today-sunrise" style="font-weight:600"></div></div>
    <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Закат</div><div id="today-sunset" style="font-weight:600"></div></div>
  </div>
</section>

<!-- Панель: 7 дней -->
<section id="panel-week" class="glass" style="padding:16px;display:none">
  <h3 style="margin-top:0">Прогноз на 7 дней</h3>
  <div id="week-wrap">—</div>
</section>

{% endblock %}
{% block scripts %}
<script>
(function(){
  // Утилиты
  const $ = s=>document.querySelector(s);
  const fmtNum = (v,d=1)=> (typeof v==="number"&&!Number.isNaN(v)? v.toFixed(d): "—");
  const fmtUnit = (v,u="",d=1)=> v==null? "—" : `${fmtNum(v,d)}${u && !u.startsWith('°')? ' '+u : u}`;
  const fmtTime = iso => { const dt = new Date(iso); return Number.isNaN(dt)? "—" : dt.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}); };
  const fmtDate = iso => { const dt = new Date(iso); if(Number.isNaN(dt)) return "—"; const s=dt.toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long"}); return s[0].toUpperCase()+s.slice(1); };

  // Переключение вкладок
  const showTab = (key)=>{
    $('#panel-now').style.display   = key==='now'?'block':'none';
    $('#panel-today').style.display = key==='today'?'block':'none';
    $('#panel-week').style.display  = key==='week'?'block':'none';
  };
  document.querySelectorAll('[data-tab]').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

  // Основной выбор города -> загрузка трёх блоков
  async function pickCityByName(name){
    // 1) геокод (твой бэкенд уже делает, оставляю предполагаемый эндпоинт)
    const g = await fetch(`/api/geocode?q=${encodeURIComponent(name)}`).then(r=>r.json());
    if(!g || !g.lat) { $('#now-wrap').textContent='Не найдено.'; return; }
    await loadAll(g.lat, g.lon, name || g.name);
  }

  async function loadAll(lat, lon, name){
    const w = await fetch(`/api/weather?lat=${lat}&lon=${lon}`).then(r=>r.json());

    // Текущая
    $('#now-wrap').innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:40px"> ${w.current?.icon || '☁️'} </div>
        <div>
          <div style="font-weight:600">${name}</div>
          <div style="color:#9fb0c3;font-size:13px">${w.current?.desc||''}</div>
        </div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px">
        <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Темп.</div><div style="font-weight:600">${fmtUnit(w.current?.temp,'°C',1)}</div></div>
        <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Ощущ.</div><div style="font-weight:600">${fmtUnit(w.current?.feels_like,'°C',1)}</div></div>
        <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Ветер</div><div style="font-weight:600">${fmtUnit(w.current?.wind, w.current?.wind_unit||'м/с',1)}</div></div>
        <div class="glass" style="padding:10px"><div style="color:#9fb0c3;font-size:12px">Давл.</div><div style="font-weight:600">${fmtUnit(w.current?.pressure, w.current?.pressure_unit||'мм рт. ст.',0)}</div></div>
      </div>`;

    // Сегодня (суточная сводка)
    $('#today-date').textContent = fmtDate(w.daily?.time);
    $('#today-desc').textContent = w.daily?.summary || w.current?.desc || '';
    $('#today-max').textContent = fmtUnit(w.daily?.temp_max,'°C');
    $('#today-min').textContent = fmtUnit(w.daily?.temp_min,'°C');
    const windU = w.daily_units?.wind_speed_10m_max || w.hourly_units?.wind_speed_10m || 'м/с';
    $('#today-wind').textContent = fmtUnit(w.daily?.wind_max, windU, windU==='м/с'?1:0);
    $('#today-prec').textContent = fmtUnit(w.daily?.precip_sum, w.daily_units?.precipitation_sum || 'мм');
    $('#today-sunrise').textContent = fmtTime(w.daily?.sunrise);
    $('#today-sunset').textContent = fmtTime(w.daily?.sunset);

    // 7 дней
    const days = (w.week||[]).map(d=>`
      <article class="glass" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600">${fmtDate(d.time)}</div>
            <div style="color:#9fb0c3;font-size:13px">${d.desc||''}</div>
          </div>
          <div style="font-size:28px">${d.icon||'⛅'}</div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px">
          <div class="glass" style="padding:8px"><div style="color:#9fb0c3;font-size:12px">Макс</div><div style="font-weight:600">${fmtUnit(d.tmax,'°C')}</div></div>
          <div class="glass" style="padding:8px"><div style="color:#9fb0c3;font-size:12px">Мин</div><div style="font-weight:600">${fmtUnit(d.tmin,'°C')}</div></div>
          <div class="glass" style="padding:8px"><div style="color:#9fb0c3;font-size:12px">Осадки</div><div style="font-weight:600">${fmtUnit(d.precip, w.daily_units?.precipitation_sum || 'мм')}</div></div>
        </div>
      </article>`).join('');
    $('#week-wrap').innerHTML = `<div style="display:grid;grid-template-columns:1fr;gap:12px">${days||'—'}</div>`;
  }

  // Обработчик поля ввода
  const input = document.getElementById('city-input');
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); const q=input.value.trim(); if(q) pickCityByName(q); }
  });

  // дефолт
  pickCityByName('Санкт-Петербург');
})();
</script>
{% endblock %}
