{% extends "base.html" %}
{% block content %}
<h2 class="text-2xl font-bold mb-6">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</h2>
<p class="text-sm text-slate-400 mb-6">–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–¥–∫—É –ø–æ–≥–æ–¥—ã –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ —Å–µ–º—å –¥–Ω–µ–π: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –æ—Å–∞–¥–∫–∏, –≤–µ—Ç–µ—Ä –∏ –≤—Ä–µ–º—è –≤–æ—Å—Ö–æ–¥–∞/–∑–∞–∫–∞—Ç–∞.</p>
<div class="max-w-3xl">
  <div class="relative">
    <input id="city-input" type="text"
           placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫)"
           class="w-full rounded-xl bg-slate-900/70 ring-1 ring-white/5 px-4 py-3 outline-none focus:ring-cyan-500"
           autocomplete="off">
    <div id="suggestions" class="absolute z-10 mt-2 w-full rounded-xl bg-slate-900 ring-1 ring-white/10 hidden"></div>
  </div>

  <div id="result" class="mt-6 hidden space-y-4">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
      <div>
        <div class="text-lg font-semibold" id="res-title"></div>
        <div class="text-xs text-slate-400" id="res-timezone"></div>
      </div>
      <div class="text-xs text-slate-400" id="res-updated"></div>
    </div>
    <div id="days-empty" class="rounded-2xl bg-slate-900/70 p-5 text-sm text-slate-400 hidden">
      –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏.
    </div>
    <div id="days-grid" class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const input = $("#city-input");
const box = $("#suggestions");
let debounce;

const weatherCodeGroups = [
  { codes: [0], icon: "‚òÄÔ∏è", desc: "–Ø—Å–Ω–æ" },
  { codes: [1, 2], icon: "üå§Ô∏è", desc: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å" },
  { codes: [3], icon: "‚òÅÔ∏è", desc: "–û–±–ª–∞—á–Ω–æ" },
  { codes: [45, 48], icon: "üå´Ô∏è", desc: "–¢—É–º–∞–Ω" },
  { codes: [51, 53, 55], icon: "üå¶Ô∏è", desc: "–ú–æ—Ä–æ—Å—å" },
  { codes: [56, 57], icon: "üåßÔ∏è", desc: "–õ–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å" },
  { codes: [61, 63, 65], icon: "üåßÔ∏è", desc: "–î–æ–∂–¥—å" },
  { codes: [66, 67], icon: "üåßÔ∏è", desc: "–õ–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å" },
  { codes: [71, 73, 75, 77], icon: "‚ùÑÔ∏è", desc: "–°–Ω–µ–≥" },
  { codes: [80, 81, 82], icon: "üå¶Ô∏è", desc: "–õ–∏–≤–Ω–∏" },
  { codes: [85, 86], icon: "üå®Ô∏è", desc: "–°–Ω–µ–≥–æ–ø–∞–¥" },
  { codes: [95, 96, 99], icon: "‚õàÔ∏è", desc: "–ì—Ä–æ–∑–∞" }
];

const codeToIcon = code => {
  if (typeof code !== "number") {
    return { icon: "üå°Ô∏è", desc: "–ü—Ä–æ–≥–Ω–æ–∑" };
  }
  for (const group of weatherCodeGroups) {
    if (group.codes.includes(code)) {
      return group;
    }
  }
  return { icon: "üå°Ô∏è", desc: "–ü—Ä–æ–≥–Ω–æ–∑" };
};

const formatNumber = (value, digits = 1) => {
  return typeof value === "number" && !Number.isNaN(value)
    ? value.toFixed(digits)
    : null;
};

const formatWithUnit = (value, unit = "", digits = 1) => {
  const num = formatNumber(value, digits);
  if (num === null) {
    return "‚Äî";
  }
  const trimmedUnit = unit ? (unit.startsWith("¬∞") ? unit : ` ${unit}`) : "";
  return `${num}${trimmedUnit}`;
};

const formatDate = iso => {
  if (!iso) return "‚Äî";
  const date = new Date(iso);
  if (Number.isNaN(date.getTime())) return iso;
  const raw = date.toLocaleDateString("ru-RU", { weekday: "long", day: "numeric", month: "long" });
  return raw.charAt(0).toUpperCase() + raw.slice(1);
};

const formatTime = iso => {
  if (!iso) return "‚Äî";
  const date = new Date(iso);
  if (Number.isNaN(date.getTime())) return iso;
  return date.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
};

input.addEventListener("input", () => {
  clearTimeout(debounce);
  const q = input.value.trim();
  if (!q) {
    box.classList.add("hidden");
    return;
  }

  debounce = setTimeout(async () => {
    const r = await fetch(`/api/cities?q=${encodeURIComponent(q)}`);
    const items = await r.json();
    if (!items.length) {
      box.classList.add("hidden");
      return;
    }
    box.innerHTML = items.map(it => `
      <button data-lat="${it.lat}" data-lon="${it.lon}" data-name="${it.name}${it.admin1?', '+it.admin1:''}${it.country?', '+it.country:''}"
        class="w-full text-left px-4 py-2 hover:bg-slate-800">${it.name}
        <span class="text-slate-400 text-xs">${it.admin1? ' ‚Ä¢ '+it.admin1 : ''}${it.country? ' ‚Ä¢ '+it.country : ''}</span>
      </button>
    `).join("");
    box.classList.remove("hidden");

    box.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", async () => {
        input.value = btn.dataset.name;
        box.classList.add("hidden");
        const lat = btn.dataset.lat, lon = btn.dataset.lon;
        const res = await fetch(`/api/weather/weekly?lat=${lat}&lon=${lon}`);
        const w = await res.json();
        if (w.error) {
          $("#result").classList.add("hidden");
          alert(w.error);
          return;
        }
        const units = w.units || {};
        const days = Array.isArray(w.days) ? w.days : [];
        $("#result").classList.remove("hidden");
        $("#res-title").textContent = btn.dataset.name;
        $("#res-timezone").textContent = w.timezone ? `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${w.timezone}` : "";
        $("#res-updated").textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;

        const grid = $("#days-grid");
        const empty = $("#days-empty");
        if (!days.length) {
          grid.innerHTML = "";
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");
        const windUnit = units.wind_speed_10m_max || "–º/—Å";
        const windDigits = windUnit === "–º/—Å" ? 1 : 0;
        grid.innerHTML = days.map(day => {
          const iconData = codeToIcon(day.code);
          const dateLabel = formatDate(day.time);
          const max = formatWithUnit(day.temp_max, units.temperature_2m_max || "¬∞C");
          const min = formatWithUnit(day.temp_min, units.temperature_2m_min || "¬∞C");
          const precip = formatWithUnit(day.precip_sum, units.precipitation_sum || "–º–º");
          const wind = formatWithUnit(day.wind_max, windUnit, windDigits);
          const sunrise = formatTime(day.sunrise);
          const sunset = formatTime(day.sunset);
          return `
            <article class="flex flex-col gap-4 rounded-2xl bg-slate-900/70 p-5 ring-1 ring-white/5">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm uppercase tracking-wide text-slate-400">${dateLabel}</div>
                  <div class="text-sm text-slate-400">${iconData.desc}</div>
                </div>
                <div class="text-3xl">${iconData.icon}</div>
              </div>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="rounded-xl bg-slate-800/60 p-3">
                  <div class="text-xs text-slate-400">–ú–∞–∫—Å</div>
                  <div class="font-medium">${max}</div>
                </div>
                <div class="rounded-xl bg-slate-800/60 p-3">
                  <div class="text-xs text-slate-400">–ú–∏–Ω</div>
                  <div class="font-medium">${min}</div>
                </div>
              </div>
              <div class="grid grid-cols-1 gap-3 text-xs text-slate-400">
                <div>–û—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å: <span class="text-slate-100">${precip}</span></div>
                <div>–í–µ—Ç–µ—Ä, –º–∞–∫—Å: <span class="text-slate-100">${wind}</span></div>
                <div>–í–æ—Å—Ö–æ–¥: <span class="text-slate-100">${sunrise}</span></div>
                <div>–ó–∞–∫–∞—Ç: <span class="text-slate-100">${sunset}</span></div>
              </div>
            </article>
          `;
        }).join("");
      });
    });
  }, 250);
});
</script>
{% endblock %}
